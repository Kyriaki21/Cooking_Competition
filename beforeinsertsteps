DELIMITER //

CREATE TRIGGER Before_Insert_Step
BEFORE INSERT ON Steps
FOR EACH ROW
BEGIN
    DECLARE prevStep TINYINT;

    -- Find the step number of the previous step for the given recipe
    SELECT Step_number INTO prevStep FROM Steps WHERE Recipe_idRecipe = NEW.Recipe_idRecipe ORDER BY idSteps DESC LIMIT 1;

    -- If no previous step exists or the step number is consecutive, allow the insertion
    IF prevStep IS NULL OR NEW.Step_number = prevStep + 1 THEN
        -- Insert the new step
        INSERT INTO Steps (Step_number, Step_description, Recipe_idRecipe)
        VALUES (NEW.Step_number, NEW.Step_description, NEW.Recipe_idRecipe);
    ELSE
        -- If the previous step doesn't exist or step numbers are not consecutive, raise an error
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Previous step does not exist or step numbers are not consecutive for this recipe. Please insert the steps for this recipe in the correct order.';
    END IF;
END //

DELIMITER ;
